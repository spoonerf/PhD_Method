---
title: "Chapter Two Workflow"
author: "Fiona Spooner"
date: "19 October 2017"
output: html_document
---

####Europe####

Have ignored the bootstrapping of the models and the use of max, min and precipitation data, and the dredging!
```{r, warning=FALSE, message=FALSE}
LPI<-read.csv("LPI_pops_20160523_edited.csv")

LPI_pop<-subset(LPI, Specific_location==1 & System !="Marine" & Class != "Actinopterygii"& Class != "Cephalaspidomorphi"& ID != 4438)

ID<-LPI_pop$ID
pop_data<- LPI_pop[,c(1,65:127)]

pop_datab <- (pop_data [,2:64] !="NULL")
points_per_pop1950_2012 = rowSums(pop_datab)
length_id <- data.frame(ID,points_per_pop1950_2012)

LPI_EU<-merge(length_id, LPI_pop, by = "ID")
LPI_EU<-subset(LPI_EU, points_per_pop1950_2012 >=2)

LPI_EU2<-LPI_EU[,c(1:3,66:128)]   #just pop trends
LPI_EU2[LPI_EU2 == 'NULL'] = NA

```

```{r, message = FALSE, warning = FALSE}
library(taRifx)
library(mgcv)
library(zoo)

doFit = function(sp_name) {
  spid2 = subset(LPI_EU2, ID == sp_name)   #subsetting the population data by each population 
  spid = spid2[,4:66]                     #subsetting only the dates
  colnames(spid)<-1950:2012              #renaming the date column names as R doesn't like numbered column names
  
  name<-spid2$Binomial
  id<-spid2$ID
  points<-spid2$points_per_pop1950_2012
  name_id<-paste(name, id, sep="_") #creating id for naming files of plots
  Date<-as.numeric(colnames(spid))
  spidt<-destring(t(spid))
  time<-length(min(which(!is.na(spidt))):max(which(!is.na(spidt))))
  missing<-time-points
  
  Year<-Date[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]
  Population<-spidt[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]
  Population[Population == 0] <- mean(Population, na.rm=TRUE)*0.01 
  
  df<-data.frame(Year,Population)
    
  
  if (points >=6) {           ###should I be trying GAMs for populations with less than six points and if that doesn't fit then use a linear model - here I am automatically fitting a linear model if there are less than six points
    PopN = log10(Population)
    if (length(na.omit(PopN)) >=6) {
      SmoothParm = round(length(na.omit(PopN))/2)    ####added na.omit in as was getting " A term has fewer unique covariate combinations than specified maximum degrees of freedom" error
    } else{
      SmoothParm=3
    }
    mg2<-mgcv:::gam(PopN ~ s(Year, k=SmoothParm), fx=TRUE)
    pv2 <- predict(mg2,df,type="response",se=TRUE) 
    R_sq2<-summary(mg2)$r.sq
    model<-1
    pv2$fit[pv2$fit <= 0] <- NA
    lambda2<-diff(pv2$fit)
    lambda_sum2<-sum(lambda2, na.rm=TRUE)
    lambda_mean2<-mean(lambda2, na.rm=TRUE)
 
  } else {
    SmoothParm<-NA
    PopN = log10(Population)
    ml2<-lm(PopN~df$Year)
    R_sq2<-summary(ml2)$r.sq
    model<-0
    Pop_interp2<-na.approx(PopN)
    Pop_interp2[Pop_interp2<=0] <- NA
    lambda2<-diff(Pop_interp2)
    lambda_sum2<-sum(lambda2, na.rm=TRUE)
    lambda_mean2<-mean(lambda2, na.rm=TRUE)
  }
  
  res_df = data.frame(sp_name=sp_name, points=points, SmoothParm=SmoothParm, r_sq=R_sq2, model=model,lambda_sum=lambda_sum2,lambda_mean=lambda_mean2,time=time, missing=missing)
  #print(id)
  return(res_df)
}


all_df_list <- lapply(unique(LPI_EU2$ID), doFit)


```

```{r}
all_matrix <- matrix(unlist(all_df_list, use.names =FALSE), ncol=9, byrow=TRUE)
all_df <- data.frame(all_matrix)
colnames(all_df) <- c("ID", "points","SmoothParm", "r_sq", "model", "lambda_sum","lambda_mean", "length_time", "missing_years")
wd<-getwd()
```

```{r}
write.csv(all_df, paste(wd,"/Chapter_Two/Europe/", "Global_Population_Lambdas.csv", sep=""))

```

Download climate data from here - http://www.ecad.eu/download/ensembles/download.php

#E-OBS

```{r, eval=FALSE}

rmean<-brick("C:/Users/Fiona/Desktop/PhD/Climate/Europe/MeanT/tg_0.25deg_reg_v11.0.nc", varname = "tg")

tm <- seq(as.Date('1950-01-01'), as.Date('2014-12-31'), 'day')
r2 <- setZ(rmean, tm, 'days')
xmean <- zApply(r2, by=as.yearmon, fun=mean, name='months')   #this bit can take ages (hours) - it is summarasing the daily data into monthly data

writeRaster(xmean, filename="Europe_mean_mon.grd", bandorder='BIL', overwrite=TRUE)

```


```{r}

library(raster)

xy<-cbind(LPI_EU$Longitude, LPI_EU$Latitude)

id<-LPI_EU$ID

binomial<-LPI_EU$Binomial

xmean<- brick(paste(wd,"/Chapter_Two/Europe/", "Europe_mean_mon.grd", sep=""))

```

```{r,eval=FALSE}
all_EU_mean_data<-data.frame(id=numeric(0), Binomial=character(0),xy=numeric(0), year=numeric(0), month=numeric(0), rasterex=numeric(0))


for (i in 1:nlayers(xmean)) {

  rasterex<- extract(xmean[[i]], xy, buffer=50000, fun=mean, na.rm=TRUE)
  date<-names(xmean[[i]])
  date2 <- as.yearmon(date, "%b.%Y")
  dataex<-data.frame(id, binomial,xy, format(date2, "%Y"),format(date2, "%b"), rasterex)   
 # print(date2)
  all_EU_mean_data = rbind(all_EU_mean_data, dataex)
  
}

```

```{r, eval=FALSE}
colnames(all_EU_mean_data)[c(2:7)]<-c("Binomial","Longitude","Latitude", "Year", "Month", "Mean_Temp")

all_EU_mean_data_na_omit<-na.omit(all_EU_mean_data)

write.csv(all_EU_mean_data, paste(wd,"/Chapter_Two/Europe/" ,"Mean_Temp_E-OBS_50k_buff.csv", sep=""))

write.csv(all_EU_mean_data_na_omit, paste(wd,"/Chapter_Two/Europe/" ,"Mean_Temp_E-OBS_50k_buff_na_omitted.csv", sep=""))


```


```{r}

all_EU_mean_data_na_omit<-read.csv("Mean_Temp_E-OBS_50k_buff.csv")


```

```{r, warning=FALSE}
library(plyr)
library(broom)

LPI_EU2<-LPI_EU[LPI_EU$ID %in% all_EU_mean_data_na_omit$id & LPI_EU$ID!=18236 &  LPI_EU$ID!=18239 ,]
nrow(LPI_EU2)

doMean = function(sp_name) {
  spid2 = subset(LPI_EU2, ID == sp_name)   #subsetting the population data by each population
  spid = spid2[,66:128]                     #subsetting only the dates
  colnames(spid)<-1950:2012              #renaming the date column names as R doesn't like numbered column names
  climid=subset(all_EU_mean_data_na_omit, id == sp_name)  #subsetting the climate data by each population
  
  year_temp <- ddply(climid, "Year", summarise,          #calculating the annual mean for max temp, min temp and precipitation
                     mean_mean = mean(na.omit(Mean_Temp)))
  
  lt_avg <- ddply(climid, "id", summarise,              #calculating the long term mean (1950-2014) of the max temp, min temp and precipitation - for each population
                  lt_avg_mean = mean(na.omit(Mean_Temp)))
  
  year_temp$anom_mean = year_temp$mean_mean - lt_avg$lt_avg_mean     #calculating anomalies 1950-2014
  
  
  name<-spid2$Binomial
  id<-spid2$ID
  points<-spid2$points_per_pop1950_2012
  name_id<-paste(name, id, sep="_") #creating id for naming files of plots
  Date<-as.numeric(colnames(spid))
  spidt<-destring(t(spid))
  
  Year<-Date[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]
  Population<-spidt[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]
  
  Mean_mon<-climid[climid$Year %in% Year, ]$Mean_Temp

  Mean_anom<-year_temp$anom_mean[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]
  Mean<-year_temp$mean_mean[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]

  if (sum(is.nan(Mean))!=length(Mean)){
  
  lm_mean<-lm(Mean~Year)
  lm_mean_df<-tidy(lm_mean)[2,]  
  mean_df<-cbind(id,lm_mean_df)
  
  } else{
    
  mean_df<-matrix(c(id,NA,NA,NA,NA,NA), nrow=1, ncol=6)
  colnames(mean_df)<-c("id", "term", "estimate", "std.error", "statistic", "p.value")
  mean_df<-data.frame(mean_df)
  }
  

  #print(id)  
  return(mean_df)
}

all_df_list <- lapply(LPI_EU2$ID, doMean)
```

```{r, eval=FALSE}
all_matrix <- matrix(unlist(all_df_list), ncol=6, byrow=TRUE)
mean_df <- data.frame(all_matrix)
colnames(mean_df) <- c("ID", "Term","Estimate","SE","Statistic","p.val")

#write.csv(mean_df, paste(wd,"/Chapter_Two/Europe/" ,"Rate_Mean_Temp_Change.csv", sep=""))

```


#CRUTEM
#Global Climate Data

```{r, cache=TRUE, message=FALSE, warning=FALSE}
library(raster)
library(doParallel)
library(lubridate)
library(reshape2)

```

```{r, cache=TRUE}
CR30s<-brick("cru_ts3.23.1931.1940.tmp.dat.nc")
CR40s<-brick("cru_ts3.23.1941.1950.tmp.dat.nc")
CR50s<-brick("cru_ts3.23.1951.1960.tmp.dat.nc")
CR60s<-brick("cru_ts3.23.1961.1970.tmp.dat.nc")
CR70s<-brick("cru_ts3.23.1971.1980.tmp.dat.nc")
CR80s<-brick("cru_ts3.23.1981.1990.tmp.dat.nc")
CR90s<-brick("cru_ts3.23.1991.2000.tmp.dat.nc")
CR00s<-brick("cru_ts3.23.2001.2010.tmp.dat.nc")
CR10s<-brick("cru_ts3.23.2011.2014.tmp.dat.nc")

plot(CR50s[[11]], main="Mean Temperature, Novermber 1951")
```

Subsetting the data to exclude fish, populations in marine systems and those without specific locations
```{r, cache=TRUE}

LPI<-read.csv("LPI_pops_20160523_edited.csv")

LPIsp<-subset(LPI, Specific_location==1 & System !="Marine" & Class != "Actinopterygii"& Class != "Cephalaspidomorphi" )

CR<-stack(CR30s,CR40s,CR50s,CR60s,CR70s,CR80s,CR90s,CR00s,CR10s)

plot(CR[[1]], "Location of LPI Populations")
points(LPIsp$Longitude, LPIsp$Latitude)

xy<-data.frame(LPIsp$Longitude, LPIsp$Latitude)

xy<-unique(xy)     #identifying unique locations to extract climate data from 

xy_df<-data.frame(xy)
colnames(xy_df)<-c("lon", "lat")
coordinates(xy_df) <- c("lon", "lat")

print("number of populations remaining after subsetting")
length(xy_df)

```

```{r, cache=TRUE, eval=FALSE}

n<-2#number of cores to use - not sure how many I can go up to - 6 at UCL
cl<-makeCluster(n)
registerDoParallel(cl)  
getDoParWorkers()

buff<- function (year,b)  {
  
  rasterex<-raster:::extract(CR[[year]], xy_df, buff=b, fun=mean, na.rm=TRUE)
  return(rasterex)
  
}

```

```{r, cache=TRUE, eval=FALSE}
diam<-0 #size of buffer to use - in metres
lyr<-1:nlayers(CR)

stime <- system.time({
  sr <- foreach(1, .combine = cbind) %dopar% mapply(buff,lyr,diam)
})
stime

stopCluster(cl)

```

```{r, cache=TRUE, eval=FALSE}

dates<-seq(ymd('1931-01-16'),ymd('2014-12-16'), by = 'months')

datesr<-rep(dates, each=length(xy[,1]))   #each number should be number of pops

srm<-melt(sr)

lon<-xy[,1]
lat<-xy[,2]

srm2<-cbind(lon,lat,datesr, srm)

srm3<-srm2[,c(1,2,3,6)]

colnames(srm3)<-c("Longitude", "Latitude", "Date", "Mean_T")

LPI_ID<-LPIsp[,c("ID", "Longitude", "Latitude")]

LPIclim<-merge(srm3, LPI_ID, by=c("Longitude", "Latitude"))

#write.csv(LPIclim, "Global_Mean_Temp_All_LPI_nobuff_1931_moreLPI.csv")

```


```{r, cache=TRUE}
LPIclim<-read.csv("Global_Mean_Temp_All_LPI_nobuff_1931_moreLPI.csv")
  
LPIclim$Date<-as.Date(LPIclim$Date, "%Y-%m-%d")
LPIclim$Year<-format(LPIclim$Date, "%Y")

LPIclim<-na.omit(LPIclim)

LPI<-read.csv("LPI_pops_20160523_edited.csv")

LPIsp<-subset(LPI, Specific_location==1 & System !="Marine" & Class != "Actinopterygii"& Class != "Cephalaspidomorphi" & ID !=4438)

pop_data<- LPIsp[,c(1,65:120)]
ID<-LPIsp$ID

pop_datab <- (pop_data [,2:57] !="NULL")
points_per_pop1950_2005 = rowSums(pop_datab)
length_id <- data.frame(ID,points_per_pop1950_2005)

LPIsp2<-merge(length_id, LPIsp, by = "ID")
LPIsp2<-subset(LPIsp2, points_per_pop1950_2005 >=2)

LPIsp2<-LPIsp2[,c(1:3,66:121)]
LPIsp2[LPIsp2 == 'NULL'] = NA

nrow(LPIsp2)

LPIclim<-LPIclim[LPIclim$ID %in% LPIsp2$ID,]

LPIsp2<-LPIsp2[LPIsp2$ID %in% LPIclim$ID,]

```


```{r, cache=TRUE, message=FALSE, warning=FALSE}
library(broom)
library(plyr)
library(taRifx)
```

```{r, cache=TRUE}
lag<-0 #number of years before start date of pop records which I want climate data from

doMean = function(sp_name) {
  spid2 = subset(LPIsp2, ID == sp_name)   #subsetting the population data by each population
  spid = spid2[,4:59]                     #subsetting only the dates
  nid<-matrix(rep (NA, 10), nrow=1)                
  colnames(nid)<-1940:1949
  colnames(spid)<-1950:2005
  spid<-cbind(nid, spid)#renaming the date column names as R doesn't like numbered column names
  climid=subset(LPIclim, ID == sp_name)  #subsetting the climate data by each population
  
  year_temp <- ddply(climid, "Year", summarise,          #calculating the annual mean for max temp, min temp and precipitation
                     mean_mean = mean(na.omit(Mean_T)))
  name<-spid2$Binomial
  id<-spid2$ID
  points<-spid2$points_per_pop1950_2005
  name_id<-paste(name, id, sep="_") #creating id for naming files of plots
  Date<-as.numeric(colnames(spid))
  spidt<-destring(t(spid))

  Year<-Date[(min(which(!is.na(spidt)))-lag):max(which(!is.na(spidt)))]
  Population<-spidt[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]

  Mean<-year_temp$mean_mean[(min(which(!is.na(spidt)))-lag):max(which(!is.na(spidt)))]
  
  mean_change<-sum(diff(Mean))
  
  Mean_mon<-climid[climid$Year %in% Year, ]$Mean_T
  year_temp$Year<-as.numeric(year_temp$Year)

  if (sum(is.nan(Mean))!=length(Mean)){
    
    lm_mean<-lm(Mean~Year)
    #lm_mean<-lm(year_temp$mean_mean~year_temp$Year)
    lm_mean_df<-tidy(lm_mean)[2,]  
    mean_df<-cbind(id,mean_change, lm_mean_df)
    
  } else{
    
    mean_df<-matrix(c(id,mean_change,NA,NA,NA,NA,NA), nrow=1, ncol=6)
    colnames(mean_df)<-c("id","mean_change" ,"term", "estimate", "std.error", "statistic", "p.value")
    #mean_df<-data.frame(mean_df)
  }
  
  #print(mean_df)  
  return(mean_df)
}

all_df_list <- lapply(unique(LPIsp2$ID), doMean)


```

```{r, cache=TRUE}
all_matrix <- matrix(unlist(all_df_list), ncol=7, byrow=TRUE)
mean_df <- data.frame(all_matrix)
colnames(mean_df) <- c("ID", "Sum_Mean_Change","Term","Estimate","SE","Statistic","p.val")

mean_df$Estimate<-as.numeric(as.character(mean_df$Estimate))

#write.csv(mean_df, "All_LPI_All_Years_Nobuff_1931_moreLPI_end2005.csv")#to go with hyde

```

###Land Use - HILDA

Land use - HILDA dataset from http://www.wageningenur.nl/en/Expertise-Services/Chair-groups/Environmental-Sciences/Laboratory-of-Geoinformation-Science-and-Remote-Sensing/Models/Hilda.htm
```{r, warning=FALSE}
library(maptools)
r_1950 <-raster(readAsciiGrid("eu27ch1950.asc"))
r_1960 <-raster(readAsciiGrid("eu27ch1960.asc"))
r_1970 <-raster(readAsciiGrid("eu27ch1970.asc"))
r_1980 <-raster(readAsciiGrid("eu27ch1980.asc"))
r_1990 <-raster(readAsciiGrid("eu27ch1990.asc"))
r_2000 <-raster(readAsciiGrid("eu27ch2000.asc"))
r_2010 <-raster(readAsciiGrid("eu27ch2010.asc"))

r_2010b<-crop(r_2010, r_1950)    #the 2010 raster is larger than the other years so has to be ropped to the same size so that they can be stacked

r<-stack(r_1950,r_1960,r_1970,r_1980,r_1990,r_2000,r_2010b)

#writeRaster(r, paste(wd,"/Chapter_Two/Europe/" ,"Land_Use_1950_2010.grd", sep=""))

names(r)<-seq(1950,2010, by=10)

crs.geo <- CRS("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs")

proj4string(r) <- crs.geo

```

```{r, warning =FALSE}
library(rgdal)

xy<-cbind(LPI_EU$Longitude, LPI_EU$Latitude)

id<-LPI_EU$ID

xy_eu<-project(xy,"+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs")

check_xy<-data.frame(id,xy_eu)      #subsetting the populations so that only those within the landuse raster are included - means that non-EU27 populations are lost

check_xy$check<-extract(r,check_xy[,(2:3)])

check_xy2<-na.omit(check_xy)
#check_xy2<-subset(check_xy, check != "NA")

crop_id<-check_xy2[,1]

selectedRows <- (LPI_EU$ID %in% check_xy2$id)
LPI_EU_sel <- LPI_EU[selectedRows,]
points <- SpatialPoints(cbind(check_xy2[,2], check_xy2[,3]))

x<-check_xy2[,2]
y<-check_xy2[,3]

xy<-cbind(x,y)        #creating the grid around the population - 5km either side gives a grid of 121km^2

xmin<- colFromX(r[[1]], points[1:length(points),]) - 5
xmax<- colFromX(r[[1]], points[1:length(points),]) + 5
ymin<- rowFromY(r[[1]], points[1:length(points),]) - 5
ymax<- rowFromY(r[[1]], points[1:length(points),]) + 5    #changed from 5 to 12



grid_crop<-data.frame(ID=crop_id,xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax)   #setting extents of grid to extract

grid_crop2<-merge(grid_crop,LPI_EU_sel, by="ID")

grid_crop2<-subset(grid_crop2, Specific_location ==1) 


```

```{r}

result <- data.frame() #empty result dataframe
library(taRifx)

for (i in 1:length(grid_crop2$ID)) {
  
  ID<-grid_crop2[i,1]
  Binomial<-as.character(grid_crop2[i,7])
  spid = grid_crop2[i,70:132]                     #subsetting only the dates
  colnames(spid)<-1950:2012
  
  Date<-as.numeric(colnames(spid))
  spidt<-destring(t(spid))
  
  Year<-Date[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]
  Population<-spidt[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]
  
  LUmin<-min(round_any(Year, 10))
  LUmax<-max(round_any(Year, 10))
  
  crop_check<-crop(r, extent(r, grid_crop2[i,4],grid_crop2[i,5],grid_crop2[i,2],grid_crop2[i,3]))
  
  crop_df<-data.frame(as.matrix(crop_check))
  
  #crop_df<-na.omit(crop_df)
  
  colnames(crop_df)<-seq(1950,2010, by=10)
  
  col<-as.numeric(colnames(crop_df[,1:7]))
  
  min_yr<-min(which(col>=LUmin))
  max_yr<-max(which(col<=LUmax))
  
  if (min_yr != max_yr) {
    
    crop_df$check<-rowSums(crop_df[,min_yr] == crop_df[,c(min_yr:max_yr)])
    
  }else{
    crop_df$check<-1
  }

  crop_df$change<-  crop_df$check != length(seq(min_yr,max_yr, by=1))
  
  change_rate<-sum(na.omit(crop_df$change=="TRUE"))/length(na.omit(crop_df$change))
  
  #print(change_rate)
  
  final<-cbind(ID,Binomial,change_rate) 
  result<-rbind(final,result)
  
}

```


```{r, eval=FALSE}

write.csv(result, paste(wd,"/Chapter_Two/Europe/" ,"LPI_LandUse_121_18_09_2015.csv", sep="" ))
LPI_LUC<-merge(LPI_EU_sel, result[,c(1,3)], by="ID",all = TRUE)


```



#Land Use HYDE

Calculating land use change

```{r, warning=FALSE, message=FALSE}
#install.packages("devtools")
library(devtools)
#install_github("timnewbold/GISOperations")
library(GISOperations)
library(raster)

crop1940<-raster("crop1940AD.asc")
gras1940<-raster("gras1940AD.asc")

crop1950<-raster("crop1950AD.asc")
gras1950<-raster("gras1950AD.asc")

crop1960<-raster("crop1960AD.asc")
gras1960<-raster("gras1960AD.asc")

crop1970<-raster("crop1970AD.asc")
gras1970<-raster("gras1970AD.asc")

crop1980<-raster("crop1980AD.asc")
gras1980<-raster("gras1980AD.asc")

crop1990<-raster("crop1990AD.asc")
gras1990<-raster("gras1990AD.asc")

crop2000<-raster("crop2000AD.asc")
gras2000<-raster("gras2000AD.asc")

crop2005<-raster("crop2005AD.asc")
gras2005<-raster("gras2005AD.asc")


rlist<-list(crop1940,crop1950,crop1960,crop1970,crop1980,crop1990,crop2000,crop2005,gras1940,gras1950,gras1960,gras1970,gras1980,gras1990,gras2000,gras2005)
cellareas <- DegreeCellAreaKM(lat=coordinates(crop1940)[,2],height=res(crop1940)[2],width=res(crop1940)[1])



for (map in rlist){
  
  map_pcnt<-signif(values(map),digits=4)/cellareas
  map_pcnt_m<-matrix(map_pcnt, nrow=nrow(map), ncol=ncol(map), byrow=TRUE)
  map_pcnt_r<-raster(map_pcnt_m, xmn=map@extent[1], xmx=map@extent[2], ymn=map@extent[3], ymx=map@extent[4])
  writeRaster(map_pcnt_r, paste(names(map),"raster.tif", sep="_"),overwrite=TRUE)
  #print(names(map))
}


crop_s<-stack(list.files(path = getwd(), pattern = "^.*crop*.*.tif$"))
gras_s<-stack(list.files(path = getwd(), pattern = "^.*gras*.*.tif$"))


nat_1940<-(1 - (crop_s[[1]] + gras_s[[1]]))
nat_2005<-(1 - (crop_s[[7]] + gras_s[[7]]))
plot(nat_2005 - nat_1940, main="Change in Natural Land Use 1940 - 2005")

anth_1940<- (crop_s[[1]] + gras_s[[1]])
anth_2005<-(crop_s[[7]] + gras_s[[7]])

plot(anth_2005 - anth_1940, main="Change in Cropland and Pasture Land Use 1940 - 2005")


```


```{r, cache=TRUE}
###########LPI data

LPI_LUC<-read.csv("LPI_pops_20160523_edited.csv")

LPI_pop<-subset(LPI_LUC, Specific_location==1 & System !="Marine" & Class != "Actinopterygii"& Class != "Cephalaspidomorphi")

ID<-LPI_pop$ID
pop_data<- LPI_pop[,c(1,65:130)]

pop_datab <- (pop_data [,2:67] !="NULL")
points_per_pop1950_2012 = rowSums(pop_datab)
length_id <- data.frame(ID,points_per_pop1950_2012)

LPI_LUC<-merge(length_id, LPI_pop, by = "ID")
LPI_LUC<-subset(LPI_pop, points_per_pop1950_2012 >=2)


id<-LPI_LUC$ID
latlong<-cbind(LPI_LUC$Longitude,LPI_LUC$Latitude)

x<-latlong[,1]
y<-latlong[,2]

xy<-cbind(id,x,y) #creating the grid around the population - 5km either side gives a grid of 121km^2
xy<-na.omit(xy)
id<-xy[,1]

points<-SpatialPoints(cbind(xy[,2], xy[,3]))


xmin<- colFromX(crop_s[[1]], points[1:length(points),]) - 1
xmax<- colFromX(crop_s[[1]], points[1:length(points),]) + 1
ymin<- rowFromY(crop_s[[1]], points[1:length(points),]) - 1
ymax<- rowFromY(crop_s[[1]], points[1:length(points),]) + 1    


grid_crop<-data.frame(ID=id,xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax)   #setting extents of grid to extract

grid_crop2<-merge(grid_crop,LPI_LUC, by="ID")

grid_crop2<-subset(grid_crop2, Specific_location ==1) 

nrow(grid_crop2)
```


```{r, cache=TRUE, eval=FALSE}
library(taRifx)
library(zoo)

result <- data.frame() #empty result dataframe

for (i in 1:length(grid_crop2$ID)){
  
  ID<-grid_crop2[i,1]
  Binomial<-as.character(grid_crop2[i,6])
  spid = grid_crop2[i,69:134]                     #subsetting only the dates
  colnames(spid)<-1950:2015
  
  Date<-as.numeric(colnames(spid))
  spidt<-destring(t(spid))
  
  Year<-Date[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]
  Population<-spidt[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]

  crop_check<-crop(crop_s, extent(crop_s, grid_crop2[i,4],grid_crop2[i,5],grid_crop2[i,2],grid_crop2[i,3]))
  gras_check<-crop(gras_s, extent(gras_s, grid_crop2[i,4],grid_crop2[i,5],grid_crop2[i,2],grid_crop2[i,3]))
  
  crop_df<-data.frame(as.matrix(crop_check))
  gras_df<-data.frame(as.matrix(gras_check))
  
  decs<-c("1940","1950","1960","1970","1980","1990","2000","2005")
  colnames(crop_df)<-decs
  colnames(gras_df)<-decs
  
  mean_crop_df<-colMeans(crop_df)
  mean_crop_df2<-data.frame(mean_crop_df, decs)
  colnames(mean_crop_df2)<-c("mean_crop", "Year")
  
  mean_gras_df<-colMeans(gras_df)
  mean_gras_df2<-data.frame(mean_gras_df, decs)
  colnames(mean_gras_df2)<-c("mean_grass", "Year")
  
  Year_na<-rep(NA, length(1940:2005))
  Year_all<-1940:2005
  Yr<-cbind(Year_all, Year_na)
  colnames(Yr)<-c("Year", "Year_NA")
  
  Yr_intrp_crop<-merge(Yr, mean_crop_df2, by="Year", all=T)
  Yr_intrp_gras<-merge(Yr, mean_gras_df2, by="Year", all=T)
  
  min_yr<-min(Year)
  max_yr<-max(Year)
  
  
  if (min_yr != max_yr & min_yr < 2005 & sum(is.na(Yr_intrp_crop$mean_crop))<60) {
    
    Yr_intrp_crop$mean_crop_int<-na.approx(Yr_intrp_crop$mean_crop)
    Yr_intrp_gras$mean_gras_int<-na.approx(Yr_intrp_gras$mean_grass)
    Yr_intrp_crop$both<-Yr_intrp_crop$mean_crop_int + Yr_intrp_gras$mean_gras_int
    
    crop_change<-mean(diff(subset(Yr_intrp_crop, Year >= min_yr & Year <= max_yr)$mean_crop_int))
    gras_change<-mean(diff(subset(Yr_intrp_gras, Year >= min_yr & Year <= max_yr)$mean_gras_int))
    both_change<-mean(diff(subset(Yr_intrp_crop, Year >= min_yr & Year <= max_yr)$both))
    both_sum<-sum(diff(subset(Yr_intrp_crop, Year >= min_yr & Year <= max_yr)$both))
  }else{
    crop_change<-NA
    gras_change<-NA
    both_change<-NA
    both_sum<-NA
  }
  
  years<-max(Year)-min(Year)
  final<-cbind(ID,Binomial,crop_change, gras_change, both_change, both_sum, years) 
  result<-rbind(final,result)
  print(final)
  
}

#write.csv(result, "Hyde_crop_pasture_annual_change_sum.csv")

```


#LUH2


```{r, eval=FALSE, echo=FALSE}
library(raster)

yr<-as.character(850:2015)
date<-as.Date(yr, format="%Y" )

primf<-brick(paste(getwd(),"/states.nc", sep=""), varname="primf")
primf<-setZ(primf, date, name="year")

primn<-brick(paste(getwd(),"/states.nc", sep=""), varname="primn")
primn<-setZ(primn, date, name="year")

secdf<-brick(paste(getwd(),"/states.nc", sep=""), varname="secdf")
secdf<-setZ(secdf, date, name="year")

secdn<-brick(paste(getwd(),"/states.nc", sep=""), varname="secdn")
secdn<-setZ(secdn, date, name="year")

urban<-brick(paste(getwd(),"/states.nc", sep=""), varname="urban")
urban<-setZ(urban, date, name="year")

pastr<-brick(paste(getwd(),"/states.nc", sep=""), varname="pastr")
pastr<-setZ(pastr, date, name="year")

rnge<-brick(paste(getwd(),"/states.nc", sep=""), varname="range")
rnge<-setZ(rnge, date, name="year")

c3ann<-brick(paste(getwd(),"/states.nc", sep=""), varname="c3ann")
c3ann<-setZ(c3ann, date, name="year")

c4ann<-brick(paste(getwd(),"/states.nc", sep=""), varname="c4ann")
c4ann<-setZ(c4ann, date, name="year")

c3per<-brick(paste(getwd(),"/states.nc", sep=""), varname="c3per")
c3per<-setZ(c3per, date, name="year")

c4per<-brick(paste(getwd(),"/states.nc", sep=""), varname="c4per")
c4per<-setZ(c4per, date, name="year")

c3nfx<-brick(paste(getwd(),"/states.nc", sep=""), varname="c3nfx")
c3nfx<-setZ(c3nfx, date, name="year")

```

```{r, eval=FALSE, echo=FALSE}
primf_cr<-primf[[1091:1166]]
primn_cr<-primn[[1091:1166]]
secdf_cr<-secdf[[1091:1166]]
secdn_cr<-secdn[[1091:1166]]
urban_cr<-urban[[1091:1166]]
pastr_cr<-pastr[[1091:1166]]
rnge_cr<-rnge[[1091:1166]]
c3ann_cr<-c3ann[[1091:1166]]
c4ann_cr<-c4ann[[1091:1166]]
c3per_cr<-c3per[[1091:1166]]
c4per_cr<-c4per[[1091:1166]]
c3nfx_cr<-c3nfx[[1091:1166]]
```

```{r, eval=FALSE, echo=FALSE}
writeRaster(primf_cr, "primf_1940.tif")
writeRaster(primn_cr, "primn_1940.tif")
writeRaster(secdf_cr, "secdf_1940.tif")
writeRaster(secdn_cr, "secdn_1940.tif")
writeRaster(urban_cr, "urban_1940.tif")
writeRaster(pastr_cr, "pastr_1940.tif")
writeRaster(rnge_cr, "rnge_1940.tif")
writeRaster(c3ann_cr, "c3ann_1940.tif")
writeRaster(c4ann_cr, "c4ann_1940.tif")
writeRaster(c3per_cr, "c3per_1940.tif")
writeRaster(c4per_cr, "c4per_1940.tif")
writeRaster(c3nfx_cr, "cnfx_1940.tif")
```

```{r}
primf<-brick("primf_1940.tif")
primn<-brick("primn_1940.tif")
secdf<-brick("secdf_1940.tif")
secdn<-brick("secdn_1940.tif")
urban<-brick("urban_1940.tif")
pastr<-brick("pastr_1940.tif")
rnge<-brick("rnge_1940.tif")
c3ann<-brick("c3ann_1940.tif")
c4ann<-brick("c4ann_1940.tif")
c3per<-brick("c3per_1940.tif")
c4per<-brick("c4per_1940.tif")
c3nfx<-brick("cnfx_1940.tif")
```


```{r}
LPI<-read.csv("LPI_pops_20160523_edited.csv")

LPIsp<-subset(LPI, Specific_location==1 & System !="Marine" & Class != "Actinopterygii"& Class != "Cephalaspidomorphi" )

xy<-data.frame(LPIsp$Longitude, LPIsp$Latitude)

xy<-unique(xy)     #identifying unique locations to extract climate data from 

xy_df<-data.frame(xy)
colnames(xy_df)<-c("lon", "lat")
coordinates(xy_df) <- c("lon", "lat")

head(xy_df)

```


```{r}

library(doParallel)
library(reshape2)

layers<-list(primf, primn, secdf, secdn, urban, pastr, rnge, c3ann, c4ann, c3per, c4per, c3nfx)

df_out<-data.frame()
for (layer in layers){
  
  name<-gsub("\\d", "",names(layer))
  n<-6  #number of cores to use - not sure how many I can go up to
  cl<-makeCluster(n)
  registerDoParallel(cl)  
  days<-nlayers(layer)    #splitting the data evenly between the cores
  step<-floor(days/n)

    ptime <- system.time({   
      df<- foreach(days, .combine=cbind) %dopar%{
      rasterex <- raster:::extract(layer[[1:days]], xy_df)
        }
      }) 
    ptime 
  stopCluster(cl)

  dates<-1940:2015

  datesr<-rep(dates, each=length(xy_df))

  dfm<-melt(df)

  lon<-xy[,1]
  lat<-xy[,2]

  dfm2<-cbind(name,lon,lat,datesr, dfm)

  df_out<-rbind(df_out, dfm2)
  print(name)
}

#write.csv(df_out, "LUH_extract_all_layers.csv")

```


```{r}

library(dplyr)
a<-read.csv("D:/Fiona/Git_Method/Git_Method/LUH_extract_all_layers.csv")
head(a)
nrow(a)

unique(a$name)
a$name<-as.character(a$name)

a$name[c(a$name=="primf_."|a$name=="primn_."|a$name=="secdf_."|a$name=="secdn_.")]<-"nat"
a$name[c(a$name=="urban_."|a$name=="pastr_."|a$name=="rnge_."|a$name=="cann_."|a$name=="cper_."|a$name=="cnfx_.")]<-"anth"

unique(a$name)

an<-na.omit(a)

an_group<-an %>% 
		group_by(lon, lat, datesr, name) %>% 
		summarise(sum_land = sum(value))
```

```{r}
colnames(LPI_ID)<-c("ID", "lon", "lat")

LPILU<-merge(LPI_ID,an_group, by=c("lon", "lat"))

#write.csv(LPILU, "LUH2_Land_Use_All_LPI2.csv")
```

```{r}

LPILU<-read.csv("LUH2_Land_Use_All_LPI2.csv")

LPILU<-LPILU[LPILU$name == "nat",]

library(taRifx)

doDist = function(sp_name) {
  spid2 = subset(LPIsp, ID == sp_name)   #subsetting the population data by each population
  spid = spid2[,65:120]                     #subsetting only the dates
  colnames(spid)<-1950:2005              #renaming the date column names as R doesn't like numbered column names
  lu_id=subset(LPILU, ID == sp_name)  #subsetting the climate data by each population
  
  id<-spid2$ID
  Date<-as.numeric(colnames(spid))
  spidt<-destring(t(spid))
  
  if (sum(!is.na(spidt)) > 1) {
    Yr<-Date[min(which(!is.na(spidt))):max(which(!is.na(spidt)))]
    luyr<-subset(lu_id, datesr>=min(Yr) & datesr<= max(Yr))   #6:11 for all categories 12:13 for nat vs anth
    luyr<-luyr[order(luyr[,4]),]
    natdiff<-mean(diff(luyr$sum_land))
 
  } else{
    natdiff<-NA
  }

  euc_df<-data.frame(id, natdiff)
  print(euc_df)  
  return(euc_df)
}


all_df_list <- lapply(unique(LPIsp$ID), doDist)

all_matrix <- matrix(unlist(all_df_list), ncol=2, byrow=TRUE)
mean_df <- data.frame(all_matrix)
colnames(mean_df) <- c("ID", "Nat_change")

#write.csv(mean_df, "LUH_LUC_rate.csv")

```


#ESA

```{r}
library(raster)
library(rgdal)

# read in all esa landcover tifs
esa_files <- list.files(path = "C:/Users/Fiona/Documents/PhD/Land_Use/ESA_CCI/", pattern=".tif", full.names = TRUE)
esa <- stack(esa_files)
```

```{r}
#read in shapefile of UK in order to crop esa rasters
gb <- readOGR("UK_clip_2.shp", "UK_clip_2")
e <- extent(gb)
# crop esa to just the UK
esa_uk <- crop(esa, e)
# rename each layer to the year 
names(esa_uk) <- c('X1992', 'X1993', 'X1994', 'X1995', 'X1996', 'X1997', 'X1998', 'X1999', 'X2000', 
                   'X2001', 'X2002', 'X2003', 'X2004', 'X2005', 
                   'X2006', 'X2007', 'X2008', 'X2009', 'X2010', 'X2011', 'X2012', 'X2013', 'X2014', 'X2015')

# map which cells are different between 1992 and 2015
overall_diff = esa_uk[[1]] != esa_uk[[24]]
change = sum(getValues(overall_diff))
N = 4511*4478

p_change = 1-((N - change)/N)

# proportion of cells within a buffer of 3000 m that are an anthropogenic land cover class
temp = field[1:1000, ]


prop_anthro <- function(cells) {
  N = length(cells)
  N_10 = sum(cells==10) # Cropland_rainfed
  N_20 = sum(cells==20) #  Cropland_irrigated_or_post_flooding
  N_30 = sum(cells==30) # Mosaic_cropland_(>50%)_natural_vegetation_(tree_shrub_herb_cover)(<50%)
  #N_40 = sum(cells==40) # Mosaic_natural_vegetation_(tree_shrub_herb_cover)_(>50%)_/_cropland_(<50%)
  N_190 = sum(cells==190) # Urban
  
  N_anthro = sum(N_10, N_20, N_30, N_190)
  
  return(1 - ((N - N_anthro)/N))
  
}

cells <- cellFromRowColCombine(test, 1:10, 1:10)
temp <- xyFromCell(test, cells)
temp<-data.frame(temp)


lpi<-read.csv("C:/Users/Fiona/Documents/PhD/PhD_Method/LPI_pops_20160523_edited.csv")
lpi<-lpi[lpi$Specific_location == 1 & (lpi$Class == "Aves" | lpi$Class == "Mammalia") & !is.na(lpi$Longitude) & !is.na(lpi$Latitude),]
nrow(lpi)

xy<-data.frame(lpi$Longitude, lpi$Latitude)
xy<-unique(xy)
colnames(xy)<-c("Longitude", "Latitude")
tlpi<-xy[360,]

t = proc.time()
temp_ex = extract(esa, cbind(xy$Longitude, xy$Latitude), buffer = 3000,fun=prop_anthro) 
(proc.time() - t)
temp_ex


ex_df<-data.frame(temp_ex)

cdf<-data.frame(cbind(xy, ex_df))

cdf$diff<-cdf$ESACCI.LC.L4.LCCS.Map.300m.P1Y.2015.v2.0.7 - cdf$ESACCI.LC.L4.LCCS.Map.300m.P1Y.1992.v2.0.7

hist(cdf$diff, breaks=100)
mean(cdf$diff)
cm<-as.matrix(cdf)
head(cm)

luc<-data.frame()
for (i in 1:nrow(cm)){
  luc_i<-mean(diff(cm[i,c(3:26)]))
  xy<-matrix((cm[i,c(1:2)]), nrow=1, ncol=2)
  loc<-cbind(xy, luc_i)
  luc<-rbind(luc,loc)
  print(i)
}

colnames(luc)<-c("Longitude", "Latitude", "Annual_LUC")

lpi_luc<-merge(lpi, luc, by=c("Longitude", "Latitude"))


land_use_change<-lpi_luc[,c(1:3,194)]


lpi_df<-lpi[,c(1,31,32)]
colnames(lpi_df)<-c("ID", "Latitude", "Longitude")

lpi_luc<-merge(lpi_df, cdf, by=c("Longitude", "Latitude"))


write.csv(lpi_luc, "C:/Users/Fiona/Documents/PhD/PhD_Method/ESA_CCI_3000m_buff_LPI.csv")


```

```{r, warning=FALSE, message=FALSE, eval=FALSE}

bm<-read.csv("Amniote_Database_Aug_2015_LPI_bins.csv")

bm$Binomial<-paste(bm$genus, bm$species, sep="_")

lpibm<-merge(LPI, bm, by="Binomial")

lpibm<-data.frame(lpibm$Binomial, lpibm$ID, lpibm$adult_body_mass_g)
head(lpibm)
colnames(lpibm)<-c("Binomial", "ID", "Body_mass_g")

lpibm$Log_Body_Mass_g<-log10(lpibm$Body_mass_g)

lpibm2<-lpibm[lpibm$Body_mass_g !=-999,]


#lpibm2<-unique(lpibm2)

#lpibm2$Log_Body_Mass_g<-log10(lpibm2$Body_mass_g)

wd<-getwd()
write.csv(lpibm2, paste(wd,"/","LPI_BodyMass_Amniote_Database_edit.csv", sep=""))


```

```{r}
lpi<-read.csv("LPI_pops_20160523_edited.csv")
lpi<-lpi[,c(1,15,31,32)]

pop<-read.csv("Global_Population_Lambdas.csv")
pop<-pop[,c(2,5,8,9)]

eu_clim<-read.csv("Rate_Mean_Temp_Change.csv")
eu_clim<-eu_clim[,c(2,4)]
colnames(eu_clim)[2]<-"EOBS_Estimate"

glob_clim<-read.csv("All_LPI_All_Years_Nobuff_1931_moreLPI_end2005.csv")
glob_clim<-glob_clim[,c(2,4)]
colnames(glob_clim)[2]<-"CRUTEM_Estimate"

luc_hilda<- read.csv("LPI_LandUse_121_18_09_2015.csv")
luc_hilda<-luc_hilda[,c(2,150)]
colnames(luc_hilda)[2]<-"HILDA_change"

luc_hyde<-read.csv("Hyde_crop_pasture_annual_change_sum.csv")
luc_hyde<-luc_hyde[,c(2,6)]
colnames(luc_hyde)[2]<-"HYDE_change"

luc_luh<-read.csv("LUH_LUC_rate.csv")
luc_luh<-luc_luh[,c(2,3)]
colnames(luc_luh)[2]<-"LUH_change"

luc_esa<-read.csv("LUC_average_mean_anth_change_ESA_2017_06_27.csv")
luc_esa<-luc_esa[,c(2,3)]
colnames(luc_esa)[2]<-"ESA_change"

bm<- read.csv("LPI_BodyMass_Amniote_Database_edit.csv")
bm<-bm[,c(2,3,5)]


```


```{r}

df<-merge(merge(pop, eu_clim,by="ID", all=T), merge(glob_clim, luc_hilda, by="ID", all=T), by="ID", all=T)
df<-merge(merge(df, luc_hyde, by="ID", all=T), merge(luc_luh, bm, by="ID", all=T), by="ID", all=T)
df<-merge(df, lpi, by="ID", all=T)
head(df)
```

#Europe
```{r}
df_eu<-subset(df, !is.na(lambda_mean)& !is.na(EOBS_Estimate) & !is.na(CRUTEM_Estimate) & !is.na(HILDA_change) & !is.na(HYDE_change)& !is.na(LUH_change)& !is.na(Binomial) & length_time > 5 & r_sq >0.5 )

nrow(df_eu)

```

```{r}
df_glb<-subset(df, !is.na(lambda_mean) & !is.na(CRUTEM_Estimate) & !is.na(HYDE_change)& !is.na(LUH_change)& !is.na(Binomial) & length_time > 5&r_sq >0.5 )

nrow(df_glb)

```



```{r, message=FALSE, warning=FALSE}

library(data.table)
library(plyr)

sp_dups<-data.frame(ddply(df_glb,.(Longitude,Latitude),nrow))
sp_dups$loc_id<-1:length(sp_dups$Longitude)
df_glb<-merge(sp_dups, df_glb, by=c("Longitude","Latitude"))


parm_df<-df_glb[,c("ID","EOBS_Estimate", "CRUTEM_Estimate","HILDA_change" ,"HYDE_change", "LUH_change","Log_Body_Mass_g")]  ##ID, land use, and climate

parm_mat<-as.matrix(parm_df)
parm_scale_m<-scale(parm_mat[,c("EOBS_Estimate", "CRUTEM_Estimate","HILDA_change" ,"HYDE_change", "LUH_change","Log_Body_Mass_g")])       #use the scaling factors at the bottom of these to scale the rasters

parm_id<-parm_mat[,"ID"]

parm_df_scale<-data.frame(parm_id,parm_scale_m)

colnames(parm_df_scale)<-c("ID","EOBS_scale","CRUTEM_scale", "HILDA_scale","HYDE_scale","LUH_scale","Log_Body_Mass_g_scale" )

sp_df_scale<-merge(df_glb, parm_df_scale, by="ID")

dt_glb<-data.table(sp_df_scale)


dt_eu<-dt_glb[dt_glb$ID %in% df_eu$ID,]

```

EU loop
```{r}
climate<-c("EOBS_scale", "CRUTEM_scale")
lu<-c("HILDA_scale", "HYDE_scale", "LUH_scale")
loop_grid_eu<-expand.grid(climate, lu)
colnames(loop_grid_eu)<-c("climate", "lu")

```

glob loop
```{r}
climate<-c( "CRUTEM_scale")
lu<-c("HYDE_scale", "LUH_scale")
loop_grid<-expand.grid(climate, lu)
colnames(loop_grid)<-c("climate", "lu")

```


```{r, message=FALSE, warning=FALSE}


source("rsquaredglmm.R")

  library(lme4) 
  library(MuMIn)

coef_bind<-data.frame()

for (i in 1:nrow(loop_grid)){
  
  sel_clim<-as.character(loop_grid$climate[i])
  sel_lu<-as.character(loop_grid$lu[i])
  df_sel<-cbind(dt_glb$lambda_mean,dt_glb$loc_id,dt_glb$Binomial, dt_glb$Log_Body_Mass_g_scale,subset(dt_glb, select=c(sel_clim,sel_lu)))
  colnames(df_sel)<-c("lambda_mean","loc_id", "Binomial", "body_mass_scale", "mean_slope_scale","change_rate_scale")

  mm0<-lmer(lambda_mean ~ change_rate_scale+mean_slope_scale+change_rate_scale:mean_slope_scale+body_mass_scale+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mm0a<-lmer(lambda_mean ~ change_rate_scale+mean_slope_scale+body_mass_scale+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mm0b<-lmer(lambda_mean ~ change_rate_scale+body_mass_scale+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mm0c<-lmer(lambda_mean ~ mean_slope_scale+body_mass_scale+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mm0d<-lmer(lambda_mean ~ body_mass_scale+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mm1<-lmer(lambda_mean ~ change_rate_scale+mean_slope_scale+change_rate_scale:mean_slope_scale+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mm1a<-lmer(lambda_mean ~ change_rate_scale+mean_slope_scale+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mm1b<-lmer(lambda_mean ~ change_rate_scale+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mm1c<-lmer(lambda_mean ~ mean_slope_scale+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mmnull<-lmer(lambda_mean ~ 1+(1|Binomial)+(1|loc_id),data=df_sel, REML=F)
  mmsAICc <- model.sel(mm0,mm0a,mm0b,mm0c,mm0d,mm1,mm1a,mm1b,mm1c,mmnull)
  mmsAICc$model<-rownames(mmsAICc)
  mmsAICc<-data.frame(mmsAICc)
  mmsAICc
  
  AIC(mm0,mm0a,mm0b,mm0c,mm0d,mm1,mm1a,mm1b,mm1c,mmnull)

  mmodels_list<-list(mm0,mm0a,mm0b,mm0c,mm0d,mm1,mm1a,mm1b,mm1c,mmnull)
  mmodelsR<-lapply(mmodels_list,rsquared.glmm)
  mmodelsRsq <- matrix(unlist(mmodelsR), ncol=6, byrow=T)
  rownames(mmodelsRsq)<-c("m0","m0a","m0b","m0c","m0d","m1","m1a","m1b","m1c","mnull")

  mmodelsRsq
  
  library(MuMIn)
  mvar_imp<-summary(model.avg(mmodels_list))

  #mav<-model.avg(models_list, subset = cumsum(weight) <= 0.95)
  mmav<-model.avg(mmodels_list, subset = delta <= 6)
  
  msmav<-summary(mmav)
  
  mcoef_av<-msmav$coefmat.subset[1:5,"Estimate"]
  mcoef_df<-data.frame(mcoef_av)
  mcoef_df$lowCI<-confint(mmav)[1:5,1]
  mcoef_df$highCI<-confint(mmav)[1:5,2]
  mcoef_df
  
  
  mcoef_pcnt<-data.frame(((10^mcoef_df) - 1)*100)
  mcoef_pcnt
  
  print(sel_clim)
  print(sel_lu)
  coef_bind<-rbind(mcoef_pcnt, coef_bind)
  
}
```

```{r}
  library(MuMIn)
  mvar_imp<-summary(model.avg(mmodels_list))

  #mav<-model.avg(models_list, subset = cumsum(weight) <= 0.95)
  mmav<-model.avg(mmodels_list, subset = delta <= 6)
  
  msmav<-summary(mmav)
  
  mcoef_av<-msmav$coefmat.subset[1:5,"Estimate"]
  mcoef_df<-data.frame(mcoef_av)
  mcoef_df$lowCI<-confint(mmav)[1:5,1]
  mcoef_df$highCI<-confint(mmav)[1:5,2]
  mcoef_df
  
  
  mcoef_pcnt<-data.frame(((10^mcoef_df) - 1)*100)
  mcoef_pcnt

``` 

#Birds
```{r}
df_birds<-subset(df, !is.na(lambda_mean)& !is.na(change_rate) & !is.na(Estimate) & !is.na(Binomial) & length_time > 5 & Class=="Aves")
nrow(df_birds)

```

```{r, message=FALSE, warning=FALSE}

library(data.table)

sp_dups<-data.frame(ddply(df_birds,.(Longitude,Latitude),nrow))
sp_dups$loc_id<-1:length(sp_dups$Longitude)
df_birds<-merge(sp_dups, df_birds, by=c("Longitude","Latitude"))


parm_df<-df_birds[,c("ID","change_rate", "Estimate", "Log_Body_Mass_g")]  ##ID, land use, and climate

parm_mat<-as.matrix(parm_df)
parm_scale_b<-scale(parm_mat[,c("change_rate", "Estimate", "Log_Body_Mass_g")])       #use the scaling factors at the bottom of these to scale the rasters

parm_id<-parm_mat[,"ID"]

parm_df_scale<-data.frame(parm_id,parm_scale_b)

colnames(parm_df_scale)<-c("ID","change_rate_scale","mean_slope_scale", "body_mass_scale" )

sp_df_scale<-merge(df_birds, parm_df_scale, by="ID")

dt_birds<-data.table(sp_df_scale)

```

```{r, message=FALSE, warning=FALSE}

source("rsquaredglmm.R")

  library(lme4) 
  library(MuMIn)
  
  bm0<-lmer(lambda_mean ~ change_rate_scale+mean_slope_scale+change_rate_scale:mean_slope_scale+body_mass_scale+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bm0a<-lmer(lambda_mean ~ change_rate_scale+mean_slope_scale+body_mass_scale+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bm0b<-lmer(lambda_mean ~ change_rate_scale+body_mass_scale+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bm0c<-lmer(lambda_mean ~ mean_slope_scale+body_mass_scale+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bm0d<-lmer(lambda_mean ~ body_mass_scale+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bm1<-lmer(lambda_mean ~ change_rate_scale+mean_slope_scale+change_rate_scale:mean_slope_scale+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bm1a<-lmer(lambda_mean ~ change_rate_scale+mean_slope_scale+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bm1b<-lmer(lambda_mean ~ change_rate_scale+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bm1c<-lmer(lambda_mean ~ mean_slope_scale+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bmnull<-lmer(lambda_mean ~ 1+(1|Binomial)+(1|loc_id),data=dt_birds, REML=F)
  bmsAICc <- model.sel(bm0,bm0a,bm0b,bm0c,bm0d,bm1,bm1a,bm1b,bm1c,bmnull)
  bmsAICc$model<-rownames(bmsAICc)
  bmsAICc<-data.frame(bmsAICc)
  bmsAICc
  
  AIC(bm0,bm0a,bm0b,bm0c,bm0d,bm1,bm1a,bm1b,bm1c,bmnull)

  bmodels_list<-list(bm0,bm0a,bm0b,bm0c,bm0d,bm1,bm1a,bm1b,bm1c,bmnull)
  bmodelsR<-lapply(bmodels_list,rsquared.glmm)
  bmodelsRsq <- matrix(unlist(bmodelsR), ncol=6, byrow=T)
  rownames(bmodelsRsq)<-c("m0","m0a","m0b","m0c","m0d","m1","m1a","m1b","m1c","mnull")

  bmodelsRsq
    


```

```{r}
  library(MuMIn)
  bvar_imp<-summary(model.avg(bmodels_list))

  #mav<-model.avg(models_list, subset = cumsum(weight) <= 0.95)
  bmav<-model.avg(bmodels_list, subset = delta <= 6)
  
  bsmav<-summary(bmav)
  
  nums<-c("1", "2", "3", "12", "13", "23", "123", "234", "1234", "(Null)")
  mods<-c("bm0d", "bm1b", "bm1c", "bm0b", "bm0c", "bm1a", "bm0a", "bm1", "bm0", "bmnull")
  mod_num<-cbind(nums, mods)
  b_models<-rownames(bvar_imp$msTable)
  b_weights<-Weights(bmav)
  b_mod_weights<-cbind(b_models, b_weights)
  b_model_weights<-merge(b_mod_weights, mod_num, by.x="b_models", by.y="nums")  
  
  bcoef_av<-bsmav$coefmat.subset[1:5,"Estimate"]
  bcoef_df<-data.frame(bcoef_av)
  bcoef_df$lowCI<-confint(bmav)[1:5,1]
  bcoef_df$highCI<-confint(bmav)[1:5,2]
  bcoef_df
  
  
  bcoef_pcnt<-data.frame(((10^bcoef_df) - 1)*100)
  bcoef_pcnt

```  
    
    
    
```{r, warning=FALSE}
bcoef_pcnt$Class<-"Birds"  
mcoef_pcnt$Class<-"Mammals"  

bcoef_pcnt$Var<-rownames(bcoef_pcnt)
mcoef_pcnt$Var<-rownames(mcoef_pcnt)
colnames(bcoef_pcnt)[1]<-"ave"
colnames(mcoef_pcnt)[1]<-"ave"

coef_pcnt<-rbind(bcoef_pcnt, mcoef_pcnt)

library(ggplot2)
p1<-ggplot(coef_pcnt, aes(colour=Class))
p1<- p1 + geom_hline(yintercept = 0, colour=gray(1/2), lty=2)
p1<- p1 + geom_linerange(aes(x=Var, ymin=lowCI, ymax=highCI), lwd=2.5, position = position_dodge(width=2/3))
p1<- p1 + geom_pointrange(aes(x= Var, y=ave, ymin=lowCI, ymax=highCI), lwd=2, position=position_dodge(width=2/3), shape=21, fill="White")
#p1<- p1 + scale_y_continuous(breaks=seq(-8, 6, 2), limits=(c(-9,5))) +theme_bw() + labs(y = "Population Change (%)", x = "") + theme(legend.position="none",text=element_text(size=20),axis.text.x=element_text(size=8) , axis.title.x = element_text(margin = unit(c(5, 0, 0, 0), "mm")))
#p1<- p1 + scale_color_manual(values=c("black", "black"))
p1<-p1+coord_flip()
print(p1)

  

```


####Spatial Predictions - Europe####

```{r Prediction maps - climate}
mean_t<- brick(paste(wd,"/Chapter_Two/Europe/" ,"Europe_mean_mon.grd", sep=""))
mean_t2<-trim(mean_t)

x<-seq(-38.625, 75.125, by=0.25)
y<-seq(25.375, 71.875, by=0.25)

xy<-expand.grid(x,y)
colnames(xy)<-c("Lon", "Lat")


time<-1:nlayers(mean_t)
## add 1 for a model with an intercept
X <- cbind(1, time)

## pre-computing constant part of least squares
invXtX <- solve(t(X) %*% X) %*% t(X)

## much reduced regression model; [2] is to get the slope
quickfun <- function(y) (invXtX %*% y)[2]
x4 <- calc(mean_t, quickfun)

```

```{r, eval=FALSE}
writeRaster(x4, filename=paste(wd,"/Chapter_Two/Europe/" ,"climate_change_slope.tif", sep=""), format="GTiff", overwrite=TRUE)

```

```{r, eval=FALSE}
r<-brick(paste(wd,"/Chapter_Two/Europe/" ,"Land_Use_1950_2010.grd", sep=""))

crs.geo <- CRS("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs")

proj4string(r) <- crs.geo

names(r)<-seq(1950,2010, by=10)
plot(r)

r_df<-data.frame(as.matrix(r))

r_df$a<-as.numeric(r_df[,1] != r_df[,2])   #checking for each decade if there is a change in land use category
r_df$b<-as.numeric(r_df[,2] != r_df[,3])
r_df$c<-as.numeric(r_df[,3] != r_df[,4])
r_df$d<-as.numeric(r_df[,4] != r_df[,5])
r_df$e<-as.numeric(r_df[,5] != r_df[,6])
r_df$f<-as.numeric(r_df[,6] != r_df[,7])

r_df$total_change<-rowSums(r_df[,c(8:13)])   #total number of category changes - a way of quantifying how unstable a landscape is?


r_rast<-raster(matrix(r_df$total_change, nrow=4075,ncol=4011, byrow=T))

plot(r_rast)

extent(r_rast)<-c(2554419, 6565419, 1260409, 5335409)
crs(r_rast)<-"+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs"

r_rast

n <- c(0,0.99,0,1,6,1)
m <- matrix(n, ncol=3, byrow=TRUE)

rc <- reclassify(r_rast, m)     #reclassifying to binary rather than number of changes

f<-rep.int(1, 121)
m<-matrix(f, nrow=11)

my_fun2 <- function(x) {
  result <- sum(na.omit(x))/length(na.omit(x))
  return(result)
}


rm <- focal(rc, w=matrix(1,nrow=11,ncol=11), fun=my_fun2)    #looking at amount of change in the surrounding area

plot(rm)



```

```{r, eval=FALSE}
writeRaster(rm, paste(wd,"/Chapter_Two/Europe/" ,"land_use_change.tif", sep=""), format="GTiff", overwrite=TRUE )


```


Spatial Prediction - Europe Birds

```{r, warning=FALSE}

library(raster)
LU<-raster( paste(wd,"/Chapter_Two/Europe/" ,"land_use_change.tif", sep=""))
TM<-raster(paste(wd,"/Chapter_Two/Europe/" ,"climate_change_slope.tif", sep=""))

crs_laea<-"+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs"
extent(LU)<-c(2554419, 6565419, 1260409, 5335409)
crs(LU)<-crs_laea

TM<-projectRaster(TM, crs = crs_laea)
#plot(TM)

centre_temp_b<-attr(parm_scale_b, 'scaled:center')[2]
centre_luc_b<-attr(parm_scale_b, 'scaled:center')[1]
scale_temp_b<-attr(parm_scale_b, 'scaled:scale')[2] 
scale_luc_b<-attr(parm_scale_b, 'scaled:scale')[1] 

LU_b<-(LU  - centre_luc_b )/scale_luc_b
TM_b<-(TM -centre_temp_b)/ scale_temp_b
LU_bt<-trim(LU_b)
TM_b2<-resample(TM_b, LU_bt)
#LU_bt2<-resample(LU_ust,TM_us)

#bm<-reclassify(TM_b, c(-1,max(na.omit(values(TM_b))),0))
bird_stack<-stack(TM_b2,LU_bt)

names(bird_stack)<-c("mean_slope_scale","change_rate_scale")

# bird_average<-function(model, weight){
#   pred<-predict(bird_stack,model, re.form=NA)
#   pred_weight<-pred*weight
#   return(pred_weight)
#   }
# 
# b_mod_weights$b_weights<-as.numeric(as.character(b_model_weights$b_weights))
# 
# mapply(bird_average, model=bmodels_list, weight=b_model_weights$b_weights)

pred<-predict(bird_stack,bm1, re.form=NA)

plot(trim(10^pred))

xy <- data.frame(lon=dt_birds$Longitude, lat=dt_birds$Latitude)
coordinates(xy) <- c("lon", "lat")
proj4string(xy) <- CRS("+init=epsg:4326") # WGS 84 UTM 35S
CRS.new <- CRS("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs")
xy_new<- spTransform(xy, CRS.new)
points(xy_new)

```


Spatial Prediction - Europe Mammals
```{r}

library(raster)
LU<-raster( paste(wd,"/Chapter_Two/Europe/" ,"land_use_change.tif", sep=""))
TM<-raster(paste(wd,"/Chapter_Two/Europe/" ,"climate_change_slope.tif", sep=""))

crs_laea<-"+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs"
extent(LU)<-c(2554419, 6565419, 1260409, 5335409)
crs(LU)<-crs_laea

TM<-projectRaster(TM, crs = crs_laea)
#plot(TM)

centre_temp_m<-attr(parm_scale_m, 'scaled:center')[2]
centre_luc_m<-attr(parm_scale_m, 'scaled:center')[1]
scale_temp_m<-attr(parm_scale_m, 'scaled:scale')[2] 
scale_luc_m<-attr(parm_scale_m, 'scaled:scale')[1] 

LU_m<-(LU  - centre_luc_m )/scale_luc_m
TM_m<-(TM -centre_temp_m)/ scale_temp_m
LU_mt<-trim(LU_m)
TM_m2<-resample(TM_m, LU_mt)

mammal_stack<-stack(TM_m2,LU_mt)

names(mammal_stack)<-c("mean_slope_scale","change_rate_scale")


pred<-predict(mammal_stack,mm1, re.form=NA)

plot(trim(10^pred))

xy <- data.frame(lon=dt_mammal$Longitude, lat=dt_mammal$Latitude)
coordinates(xy) <- c("lon", "lat")
proj4string(xy) <- CRS("+init=epsg:4326") # WGS 84 UTM 35S
CRS.new <- CRS("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs")
xy_new<- spTransform(xy, CRS.new)
points(xy_new)
```



####Harmonized LUH dataset - Global / CRU Temps Global Climate####

```{r}



```

#ESA dataset - Global

```{r}



```

#Spatial Current and Future Predictions - Global
```{r, warning=FALSE}

df_bird<-read.csv("bird_data_for_prediction.csv")
df_mammal<-read.csv("mammal_data_for_prediction.csv")

# df_bird[is.na(df_bird$lambda_mean),]$lambda_mean<-0
# df_mammal[is.na(df_mammal$lambda_mean),]$lambda_mean<-0

library(plyr)
#counting duplicates at each location
sp_dups_bird<-data.frame(ddply(df_bird,.(Longitude,Latitude),nrow))
sp_dups_mamm<-data.frame(ddply(df_mammal,.(Longitude,Latitude),nrow))

sp_dups_bird$loc_id<-1:length(sp_dups_bird$Longitude)
sp_dups_mamm$loc_id<-1:length(sp_dups_mamm$Longitude)

sp_dups_df_bird<-merge(sp_dups_bird, df_bird, by=c("Longitude","Latitude"))
sp_dups_df_mamm<-merge(sp_dups_mamm, df_mammal, by=c("Longitude","Latitude"))

library(data.table)
dt_bird = as.data.table(sp_dups_df_bird)
dt_mamm = as.data.table(sp_dups_df_mamm)

parm_df_bird<-sp_dups_df_bird[,c("ID","Estimate", "both_change", "Log_Body_Mass_g")]  ##ID, land use, and climate  use "LUC_dist" or "Nat_change" for purely annual change in summed primary, secondary and other
parm_df_mamm<-sp_dups_df_mamm[,c("ID","Estimate", "both_change", "Log_Body_Mass_g")]  ##ID, land use, and climate  use "LUC_dist" or "Nat_change" for purely annual change in summed primary, secondary and othe

parm_mat_bird<-as.matrix(parm_df_bird)
parm_mat_mamm<-as.matrix(parm_df_mamm)

parm_scale_bird<-scale(parm_mat_bird[,c("Estimate", "both_change", "Log_Body_Mass_g")])       #use the scaling factors at the bottom of these to scale the rasters
parm_scale_mamm<-scale(parm_mat_mamm[,c("Estimate", "both_change", "Log_Body_Mass_g")])       #use the scaling factors at the bottom of these to scale the rasters

parm_id_bird<-parm_mat_bird[,"ID"]
parm_id_mamm<-parm_mat_mamm[,"ID"]

parm_df_scale_bird<-data.frame(parm_id_bird,parm_scale_bird)
parm_df_scale_mamm<-data.frame(parm_id_mamm,parm_scale_mamm)

colnames(parm_df_scale_bird)<-c("ID","mean_slope_scale", "change_rate_scale", "Bodymass_scale")
colnames(parm_df_scale_mamm)<-c("ID","mean_slope_scale", "change_rate_scale", "Bodymass_scale")

sp_df_scale_bird<-merge(sp_dups_df_bird, parm_df_scale_bird, by="ID")
sp_df_scale_mamm<-merge(sp_dups_df_mamm, parm_df_scale_mamm, by="ID")

dt_bird<-data.table(sp_df_scale_bird)
dt_mamm<-data.table(sp_df_scale_mamm)
```


```{r}
library(lme4)
m1c_b<-lmer(lambda_mean ~ mean_slope_scale+(1|Binomial)+(1|loc_id),data=dt_bird, REML=F)
m1c_m<-lmer(lambda_mean ~ mean_slope_scale+(1|Binomial)+(1|loc_id),data=dt_mamm, REML=F)

m1_m<-lmer(lambda_mean ~ change_rate_scale+mean_slope_scale+change_rate_scale:mean_slope_scale+(1|Binomial)+(1|loc_id),data=dt_mamm, REML=F)
```

```{r, cache=TRUE}
###############################################
library(raster)

CR40s<-brick("cru_ts3.23.1941.1950.tmp.dat.nc")
CR50s<-brick("cru_ts3.23.1951.1960.tmp.dat.nc")
CR60s<-brick("cru_ts3.23.1961.1970.tmp.dat.nc")
CR70s<-brick("cru_ts3.23.1971.1980.tmp.dat.nc")
CR80s<-brick("cru_ts3.23.1981.1990.tmp.dat.nc")
CR90s<-brick("cru_ts3.23.1991.2000.tmp.dat.nc")
CR00s<-brick("cru_ts3.23.2001.2010.tmp.dat.nc")

obs<-stack(CR40s[[109:120]], CR50s, CR60s, CR70s, CR80s, CR90s,CR00s[[1:48]] )
year_mon<-rep(1:(nlayers(obs)/12), each=12)


#changing from monthly to annual data
year_s<-stackApply(obs, indices=year_mon, fun=mean, na.rm=TRUE)


```

```{r}
#####HadGEM ES

### rcp 85

ts85_05_30<-brick("ts_Amon_HadGEM2-ES_esmrcp85_r1i1p1_200512-203011.nc")
ts85_30_55<-brick("ts_Amon_HadGEM2-ES_esmrcp85_r1i1p1_203012-205511.nc")
ts85_55_80<-brick("ts_Amon_HadGEM2-ES_esmrcp85_r1i1p1_205512-208011.nc")
ts85_80_00<-brick("ts_Amon_HadGEM2-ES_esmrcp85_r1i1p1_208012-210011.nc")

ts85_05_00<-stack(ts85_05_30,ts85_30_55,ts85_55_80,ts85_80_00)

### rcp 26

ts26_05_30<-brick("ts_Amon_HadGEM2-ES_rcp26_r1i1p1_200512-203011.nc")
ts26_30_55<-brick("ts_Amon_HadGEM2-ES_rcp26_r1i1p1_203012-205511.nc")
ts26_55_80<-brick("ts_Amon_HadGEM2-ES_rcp26_r1i1p1_205512-208011.nc")
ts26_80_00<-brick("ts_Amon_HadGEM2-ES_rcp26_r1i1p1_208012-209911.nc")
ts26_00_12<-brick("ts_Amon_HadGEM2-ES_rcp26_r1i1p1_209912-212411.nc")

ts26_05_00<-stack(ts26_05_30,ts26_30_55,ts26_55_80,ts26_80_00, ts26_00_12[[1:12]])
#ts_05_00<-brick(ts_05_00)

```

```{r}
#rcp85
modelcc<-rotate(ts85_05_00)

obs_r<-suppressWarnings(resample(obs, modelcc))

obs_rk<-obs_r+273.15

mask_mod<-mask(modelcc, obs_rk[[1]])

#obs_mod<-stack(obs_rk, modelcc)

obs_mod<-stack(obs_rk, mask_mod)

obs_mod_mon_mean<-matrix(cellStats(obs_mod, mean))

plot(obs_mod_mon_mean)

#############################################

```


```{r}
#rcp26
modelcc_26<-rotate(ts26_05_00)

obs_r_26<-suppressWarnings(resample(obs, modelcc_26))


obs_rk_26<-obs_r_26+273.15

mask_mod_26<-mask(modelcc_26, obs_rk_26[[1]])

#obs_mod<-stack(obs_rk, modelcc)

obs_mod_26<-stack(obs_rk_26, mask_mod_26)

obs_mod_mon_mean_26<-matrix(cellStats(obs_mod_26, mean))

plot(obs_mod_mon_mean_26)

#############################################

```



```{r}
#rcp85
year_mon<-rep(1:(nlayers(obs_mod)/12), each=12)

#changing from monthly to annual data
obs_mod_ann<-stackApply(obs_mod, indices=year_mon, fun=mean, na.rm=TRUE)

obs_mat_ann<-matrix(cellStats(obs_mod_ann, mean))

plot(obs_mat_ann)


```

```{r}

time<-1:nlayers(obs_mod_ann[[50:150]])

X <- cbind(1, time)

## pre-computing constant part of least squares
invXtX <- solve(t(X) %*% X) %*% t(X)

## much reduced regression model; [2] is to get the slope
quickfun <- function(y) (invXtX %*% y)[2]
rate_85 <- calc(obs_mod_ann[[50:150]], quickfun)
plot(rate_85)

cellStats(rate_85, stat=mean)

```




```{r}
#rcp26
year_mon_26<-rep(1:(nlayers(obs_mod_26)/12), each=12)

#changing from monthly to annual data
obs_mod_ann_26<-stackApply(obs_mod_26, indices=year_mon_26, fun=mean, na.rm=TRUE)

obs_mat_ann_26<-matrix(cellStats(obs_mod_ann_26, mean))
years<-1951:2100
plot(years,obs_mat_ann_26 - 273.15 )

df<-data.frame(years, obs_mat_ann_26 - 273.15)
colnames(df)[2]<-"Mean_Temp"
df$Observed_Predict<-as.factor(c(rep("Observed",54), rep("Predicted",96)))

ggplot(df, aes(x= years, y= Mean_Temp, colour = Observed_Predict))+
  geom_point() + 
  ylim(7.5, 17) +
  labs(y = expression(Global~Mean~Temperature^{o}~C), x = "Year", colour = "", title = "RCP 2.6")
  
  
```


```{r}

time<-1:nlayers(obs_mod_ann_26[[50:150]])

X <- cbind(1, time)

## pre-computing constant part of least squares
invXtX <- solve(t(X) %*% X) %*% t(X)

## much reduced regression model; [2] is to get the slope
quickfun <- function(y) (invXtX %*% y)[2]
rate_26 <- calc(obs_mod_ann_26[[50:150]], quickfun)
plot(rate_26)

cellStats(rate_26, stat=mean)

```

```{r}
#rcp85
x = c(1:150)
g = mgcv:::gam(obs_mat_ann~s(x, k=8), fx=TRUE)
plot(g)

g_pred = predict(g)
g_pred = g_pred[55:150]
d = diff(g_pred)
plot(g_pred)
plot(d)
```


```{r}
#rcp26
x = c(1:150)
g_26 = mgcv:::gam(obs_mat_ann_26~s(x, k=8), fx=TRUE)
plot(g_26)

g_pred_26 = predict(g_26)
g_pred_26 = g_pred_26[55:150]
d_26 = diff(g_pred_26)
plot(g_pred_26)
plot(d_26)
```


```{r}
#bird values
centre_tempb<-0.045237717 
scale_tempb<-0.071445065 

#mammal values
centre_tempm<-0.015412738 
scale_tempm<-0.079118974
```


```{r}
#rcp85
gam_diff_b<-scale(d, center=centre_tempb, scale=scale_tempb)
plot(gam_diff_b)

gam_diff_m<-scale(d, center=centre_tempm, scale=scale_tempm)
plot(gam_diff_m)
```

```{r}
#rcp26
gam_diff_b_26<-scale(d_26, center=centre_tempb, scale=scale_tempb)
plot(gam_diff_b_26)

gam_diff_m_26<-scale(d_26, center=centre_tempm, scale=scale_tempm)
plot(gam_diff_m_26)
```



```{r}
#rcp85
ave_mod_b<-data.frame(gam_diff_b, rep(0, length(gam_diff_b)), rep(0, length(gam_diff_b)))
colnames(ave_mod_b)<-c("mean_slope_scale", "change_rate_scale", "Bodymass_scale")
pop_pred_b<-stats:::predict(m1c_b, ave_mod_b, re.form=NA, se.fit=TRUE)

ave_mod_m<-data.frame(gam_diff_m, rep(0, length(gam_diff_m)), rep(0, length(gam_diff_m)))
colnames(ave_mod_m)<-c("mean_slope_scale", "change_rate_scale", "Bodymass_scale")
pop_pred_m<-predict(m1_m, ave_mod_m, re.form=NA, se.fit=T)
```

```{r, warning=FALSE, message=FALSE}
#rcp26
ave_mod_b_26<-data.frame(gam_diff_b_26, rep(0, length(gam_diff_b_26)), rep(0, length(gam_diff_b_26)))
colnames(ave_mod_b_26)<-c("mean_slope_scale", "change_rate_scale", "Bodymass_scale")
pop_pred_b_26<-predict(m1c_b, ave_mod_b_26, re.form=NA, se.fit=T)

ave_mod_m_26<-data.frame(gam_diff_m_26, rep(0, length(gam_diff_m_26)), rep(0, length(gam_diff_m_26)))
colnames(ave_mod_m_26)<-c("mean_slope_scale", "change_rate_scale", "Bodymass_scale")
pop_pred_m_26<-stats:::predict(m1_m, ave_mod_m_26, re.form=NA, se.fit=T)
```


```{r}
#rcp85
plot(pop_pred_b$fit, ylim=c(-0.045, 0.005), main="Birds RCP 8.5", type="l")
lines(pop_pred_b$fit + 1.96*pop_pred_b$se.fit, col="red", lty=2)
lines(pop_pred_b$fit - 1.96*pop_pred_b$se.fit, col="red", lty=2)

plot(pop_pred_m$fit, ylim=c(-0.02, 0.01), main="Mammals RCP 8.5",  type="l")
lines(pop_pred_m$fit + 1.96*pop_pred_m$se.fit, col="red", lty=2)
lines(pop_pred_m$fit - 1.96*pop_pred_m$se.fit, col="red", lty=2)
```

```{r}
#rcp26
plot(pop_pred_b_26$fit, ylim=c(-0.045, 0.025), main="Birds RCP 2.6", type="l")
lines(pop_pred_b_26$fit + 1.96*pop_pred_b_26$se.fit, col="red", lty=2)
lines(pop_pred_b_26$fit - 1.96*pop_pred_b_26$se.fit, col="red", lty=2)

plot(pop_pred_m_26$fit, ylim=c(-0.015, 0.015), main="Mammals RCP 2.6",  type="l")
lines(pop_pred_m_26$fit + 1.96*pop_pred_m_26$se.fit, col="red", lty=2)
lines(pop_pred_m_26$fit - 1.96*pop_pred_m_26$se.fit, col="red", lty=2)
```


```{r}
10^sum(pop_pred_b$fit + 1.96*pop_pred_b$se.fit)
10^sum(pop_pred_b$fit - 1.96*pop_pred_b$se.fit)
10^sum(pop_pred_b$fit)

10^sum(pop_pred_m$fit + 1.96*pop_pred_m$se.fit)
10^sum(pop_pred_m$fit - 1.96*pop_pred_m$se.fit)
10^sum(pop_pred_m$fit)
```

```{r}
#rcp85
pop_pred_b$fit2<-c(0, pop_pred_b$fit)
pop_pred_b$se.fit2<-c(0, pop_pred_b$se.fit)

pop_pred_m$fit2<-c(0, pop_pred_m$fit)
pop_pred_m$se.fit2<-c(0, pop_pred_m$se.fit)
```

```{r}
#rcp26
pop_pred_b_26$fit2<-c(0, pop_pred_b_26$fit)
pop_pred_b_26$se.fit2<-c(0, pop_pred_b_26$se.fit)

pop_pred_m_26$fit2<-c(0, pop_pred_m_26$fit)
pop_pred_m_26$se.fit2<-c(0, pop_pred_m_26$se.fit)
```

```{r}
plot(y=10^cumsum(pop_pred_b$fit2), x=2005:2100, ylim=c(0, 1.5), type="l", ylab="Bird Population Index", xlab="Year", main="Predicted Bird Population Index Under Scenario RCP 8.5")
lines(y=10^cumsum(pop_pred_b$fit2 - 1.96*pop_pred_b$se.fit2), x=2005:2100, lty=2, col="Red")
lines(y=10^cumsum(pop_pred_b$fit2 + 1.96*pop_pred_b$se.fit2), x=2005:2100, lty=2, col="Red")
```

```{r}
plot(y=10^cumsum(pop_pred_m$fit2), x=2005:2100, ylim=c(0, 3), type="l", ylab="Mammal Population Index", xlab="Year", main="Predicted Mammal Population Trends Under RCP 8.5")
lines(y=10^cumsum(pop_pred_m$fit2 - 1.96*pop_pred_m$se.fit2), x=2005:2100, lty=2, col="Red")
lines(y=10^cumsum(pop_pred_m$fit2 + 1.96*pop_pred_m$se.fit2), x=2005:2100, lty=2, col="Red")

```

```{r}
#Birds RCP 8.5
yb<-10^cumsum(pop_pred_b$fit2)
xb<-2005:2100
lcib<-10^cumsum(pop_pred_b$fit2 - 1.96*pop_pred_b$se.fit2)
ucib<-10^cumsum(pop_pred_b$fit2 + 1.96*pop_pred_b$se.fit2)

dfb<-data.frame(xb,yb, lcib, ucib)

library(ggplot2)

ggplot(dfb, aes(xb,yb))+
  geom_line(size=2)+
  geom_ribbon(aes(ymin=lcib, ymax=ucib), alpha=0.3, fill = "red")+
  labs(y = "Bird Population Index RCP 8.5", x = "")+
  scale_y_continuous(breaks=seq(0, 1, 0.25))+
  theme_bw()+
  theme(text = element_text(size=20), axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")))+
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
```

```{r}
#Birds RCP 2.6
yb_26<-10^cumsum(pop_pred_b_26$fit2)
xb_26<-2005:2100
lcib_26<-10^cumsum(pop_pred_b_26$fit2 - 1.96*pop_pred_b_26$se.fit2)
ucib_26<-10^cumsum(pop_pred_b_26$fit2 + 1.96*pop_pred_b_26$se.fit2)

dfb_26<-data.frame(xb_26,yb_26, lcib_26, ucib_26)

library(ggplot2)

ggplot(dfb_26, aes(xb_26,yb_26))+
  geom_line(size=2)+
  geom_ribbon(aes(ymin=lcib_26, ymax=ucib_26), alpha=0.3, fill="red")+
  labs(y = "Bird Population Index RCP 2.6", x = "")+
  #scale_y_continuous(breaks=seq(0, 1, 0.25))+
 theme_bw()+
  theme(text = element_text(size=20), axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")))+
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
```

```{r}
#Mammals RCP 8.5

ym<-10^cumsum(pop_pred_m$fit2)
xm<-2005:2100
lcim<-10^cumsum(pop_pred_m$fit2 - 1.96*pop_pred_m$se.fit2)
ucim<-10^cumsum(pop_pred_m$fit2 + 1.96*pop_pred_m$se.fit2)

dfm<-data.frame(xm,ym, lcim, ucim)

library(ggplot2)

ggplot(dfm, aes(xm,ym))+
  geom_line(size=2)+
  geom_ribbon(aes(ymin=lcim, ymax=ucim), alpha=0.3, fill="darkturquoise")+
  labs(y = "Mammal Population Index RCP 8.5", x = "")+
  #scale_y_continuous(breaks=seq(0, 1, 0.5))+
   theme_bw()+
  theme(text = element_text(size=20), axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")))+
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
```

```{r}
#Mammals RCP 2.6

ym_26<-10^cumsum(pop_pred_m_26$fit2)
xm_26<-2005:2100
lcim_26<-10^cumsum(pop_pred_m_26$fit2 - 1.96*pop_pred_m_26$se.fit2)
ucim_26<-10^cumsum(pop_pred_m_26$fit2 + 1.96*pop_pred_m_26$se.fit2)

dfm_26<-data.frame(xm_26,ym_26, lcim_26, ucim_26)

library(ggplot2)

ggplot(dfm_26, aes(xm_26,ym_26))+
  geom_line(size=2)+
  geom_ribbon(aes(ymin=lcim_26, ymax=ucim_26), alpha=0.3, fill="darkturquoise")+
  labs(y = "Mammal Population Index RCP 2.6", x = "")+
  #scale_y_continuous(breaks=seq(0, 1, 0.25))+
    theme_bw()+
  theme(text = element_text(size=20), axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")))+
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
```


#Spatial prediction on observed trends
```{r}
################function for doing it all spatially
#birds observed
x = c(1:nlayers(year_s))

funob<-function(y){
  
  z<-matrix(y)
  if (sum(is.na(z))<1){
    g<-mgcv:::gam(matrix(z) ~ s(x, k=8), fx=TRUE)
    g_pred<-predict(g)
    #g_pred<-g_pred[55:148]
    #g_pred<-g_pred[55:100] #2050
    d<-diff(g_pred)
    gam_diff<-scale(d, center = centre_tempb, scale = scale_tempb)
    ave_mod<-data.frame(gam_diff, rep(0, length(gam_diff)), rep(0, length(gam_diff)))
    colnames(ave_mod)<-c("mean_slope_scale", "change_rate_scale", "Bodymass_scale")
    pop_pred<-predict(m1c_b, ave_mod, re.form=NA)
  } else{
    
    #pop_pred$fit<-rep(NA,45) #2050
    pop_pred<-rep(NA,nlayers(year_s))
  }
  return(pop_pred)
}

obs_bird<-calc(year_s, funob)

```


#Future Spatial Predictions


```{r}
################function for doing it all spatially
#mammals 
x = c(1:150)

funm<-function(y){
  
  z<-matrix(y)
  if (sum(is.na(z))<1){
    g<-mgcv:::gam(matrix(z) ~ s(x, k=8), fx=TRUE)
    g_pred<-predict(g)
    g_pred<-g_pred[55:148]
    #g_pred<-g_pred[55:100] #2050
    d<-diff(g_pred)
    gam_diff<-scale(d, center = centre_tempm, scale = scale_tempm)
    ave_mod<-data.frame(gam_diff, rep(0, length(gam_diff)), rep(0, length(gam_diff)))
    colnames(ave_mod)<-c("mean_slope_scale", "change_rate_scale", "Bodymass_scale")
    pop_pred<-predict(m1_m, ave_mod, re.form=NA, se.fit=T)
  } else{
    
    #pop_pred$fit<-rep(NA,45) #2050
    pop_pred$fit<-rep(NA,93)
  }
  return(pop_pred$fit)
}

#gam_pred_rast_2050<-calc(obs_mod_ann, fun)
#gam_pred_rast<-calc(obs_mod_ann, fun)

```

```{r}
#rcp 8.5
pred_rast_mammal<-calc(obs_mod_ann, funm)

ave_lam_mammal<-calc(pred_rast_mammal, fun=mean)
plot(10^ave_lam_mammal)

pgr_mammal<-10^pred_rast_mammal
prod_lam_mammal<-calc(pgr_mammal, fun=prod)
plot(prod_lam_mammal)
```

```{r}
#rcp 2.6
pred_rast_mammal_26<-calc(obs_mod_ann_26, funm)

ave_lam_mammal_26<-calc(pred_rast_mammal_26, fun=mean)
plot(10^ave_lam_mammal_26)

pgr_mammal_26<-10^pred_rast_mammal_26
prod_lam_mammal_26<-calc(pgr_mammal_26, fun=prod)
plot(prod_lam_mammal_26)
```

```{r}
################function for doing it all spatially
#birds rcp 8.5
x = c(1:150)

funb<-function(y){
  
  z<-matrix(y)
  if (sum(is.na(z))<1){
    g<-mgcv:::gam(matrix(z) ~ s(x, k=8), fx=TRUE)
    g_pred<-predict(g)
    g_pred<-g_pred[55:148]
    #g_pred<-g_pred[55:100] #2050
    d<-diff(g_pred)
    gam_diff<-scale(d, center = centre_tempb, scale = scale_tempb)
    ave_mod<-data.frame(gam_diff, rep(0, length(gam_diff)), rep(0, length(gam_diff)))
    colnames(ave_mod)<-c("mean_slope_scale", "change_rate_scale", "Bodymass_scale")
    pop_pred<-predict(m1c_b, ave_mod, re.form=NA, se.fit=T)
  } else{
    
    #pop_pred$fit<-rep(NA,45) #2050
    pop_pred$fit<-rep(NA,93)
  }
  return(pop_pred$fit)
}

#gam_pred_rast_2050<-calc(obs_mod_ann, fun)
#gam_pred_rast<-calc(obs_mod_ann, fun)
```

```{r}
pred_rast_bird<-calc(obs_mod_ann, funb)

ave_lam_b<-calc(pred_rast_bird, fun=mean)
plot(10^ave_lam_b)

pgr_b<-10^pred_rast_bird
prod_lam_b<-calc(pgr_b, fun=prod)
plot(prod_lam_b)


```

```{r}
pred_rast_bird_26<-calc(obs_mod_ann_26, funb)

ave_lam_b_26<-calc(pred_rast_bird_26, fun=mean)
plot(10^ave_lam_b_26)

pgr_b_26<-10^pred_rast_bird_26
prod_lam_b_26<-calc(pgr_b_26, fun=prod)
plot(prod_lam_b_26)


```


#Future Spatial Predictions

```{r}

pop_index_2100<-function(x){10^cumsum(x)}

index_2100_bird<-calc(pred_rast_bird, pop_index_2100)
index_2100_mammal<-calc(pred_rast_mammal, pop_index_2100)

```

```{r}
library(RColorBrewer)
library(rgdal)
library(ggplot2)
library(rgeos)
world<-readOGR(dsn=getwd(), layer="ne_10m_land") #download from http://www.naturalearthdata.com/downloads/10m-physical-vectors/10m-land/
e<-c(-180, 180, -63, 83.6341)
world_c<-crop(world, e)
plot(world_c)
world_df<-fortify(world_c)
colnames(world_df)[c(1:2)]<-c("Longitude", "Latitude")

```

```{r}
pred_2100_bird<-rasterToPoints(index_2100_bird)
#pred_2100_df<-rasterToPoints(log10(pred_2100))
pred_2100_bird2<-data.frame(pred_2100_bird)
colnames(pred_2100_bird2)<-c("Longitude", "Latitude", "Population_Decline")

```

```{r}
theme_opts<-list(theme(panel.grid.minor = element_blank(),
                       panel.grid.major = element_blank(),
                       panel.background = element_rect(fill = 'white', colour = NA),
                       plot.background = element_rect(),
                       axis.line = element_blank(),
                       axis.text.x = element_blank(),
                       axis.text.y = element_blank(),
                       axis.ticks = element_blank(),
                       axis.title.x = element_blank(),
                       axis.title.y = element_blank()))

ggplot(data=pred_2100_bird2, aes(Longitude, Latitude))+
  geom_raster(aes(fill=Population_Decline))+
  scale_fill_gradientn(colors=brewer.pal(7, "RdYlGn"), guide=guide_colourbar(title=""))+ 
  #labels=c("-99%", "-50%", "0%", "+50%", "+100%"), breaks=c(0.01,0.5, 1, 1.5, 2))+   
  #labels=c("-99.9999%", "-99.99%", "-99%","0%"))+
  geom_path(data=world_df, aes(Longitude, Latitude, group=group))+
  coord_fixed(ratio = 1)+
  theme_bw()+
  labs(title="Bird Population Index 2100 - (2005 = 1)")+
  theme(text = element_text(size=20))

```


```{r}
pred_2100_mammal<-rasterToPoints(index_2100_mammal)
#pred_2100_df<-rasterToPoints(log10(pred_2100))
pred_2100_mammal2<-data.frame(pred_2100_mammal)
colnames(pred_2100_mammal2)<-c("Longitude", "Latitude", "Population_Decline")

```

```{r}
theme_opts<-list(theme(panel.grid.minor = element_blank(),
                       panel.grid.major = element_blank(),
                       panel.background = element_rect(fill = 'white', colour = NA),
                       plot.background = element_rect(),
                       axis.line = element_blank(),
                       axis.text.x = element_blank(),
                       axis.text.y = element_blank(),
                       axis.ticks = element_blank(),
                       axis.title.x = element_blank(),
                       axis.title.y = element_blank()))

ggplot(data=pred_2100_mammal2, aes(Longitude, Latitude))+
  geom_raster(aes(fill=Population_Decline))+
  scale_fill_gradientn(colors=brewer.pal(7, "RdYlGn"), guide=guide_colourbar(title=""))+ 
  #labels=c("-99%", "-50%", "0%", "+50%", "+100%"), breaks=c(0.01,0.5, 1, 1.5, 2))+   
  #labels=c("-99.9999%", "-99.99%", "-99%","0%"))+
  geom_path(data=world_df, aes(Longitude, Latitude, group=group))+
  coord_fixed(ratio = 1)+
  theme_bw()+
  labs(title="Mammal Population Index 2100 - (2005 = 1)")+
  theme(text = element_text(size=20))

```
